
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Factory Girl 201 - Drafts Previewer</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="My second article about this popular and useful Ruby gem deals with a couple more nuanced topics that beginners don’t necessarily need to concern &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://vis-kid.github.io/octopress_drafts_previewer/blog/2015/10/20/Factory-Girl-Guide-02/">
  <link href="/octopress_drafts_previewer/favicon.png" rel="icon">
  <link href="/octopress_drafts_previewer/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/octopress_drafts_previewer/atom.xml" rel="alternate" title="Drafts Previewer" type="application/atom+xml">
  <script src="/octopress_drafts_previewer/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/octopress_drafts_previewer/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/octopress_drafts_previewer/">Drafts Previewer</a></h1>
  
    <h2>Simple way to share my drafts for feedback</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/octopress_drafts_previewer/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="vis-kid.github.io/octopress_drafts_previewer">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/octopress_drafts_previewer/">Blog</a></li>
  <li><a href="/octopress_drafts_previewer/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Factory Girl 201</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-10-20T05:29:10+02:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:29 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><img src="/octopress_drafts_previewer/images/Factory-Girl-Guide/Factory_Guide_Association_cropped.png"></p>

<p>My second article about this popular and useful Ruby gem deals with a couple more nuanced topics that beginners don’t necessarily need to concern themselves right away when they get started. Again, I did my best to keep it newbie-accessible and explain every bit of lingo people new to TDD might stumble over.</p>

<h3>Topics</h3>

<ul>
<li>Traits</li>
<li>Aliases</li>
<li>Callbacks</li>
<li>Associations</li>
<li>Lazy attributes</li>
<li>Modifying factories</li>
<li>Transient attributes</li>
<li><p>Dependent attributes</p></li>
<li><h3>Dependent Attributes</h3></li>
</ul>


<p>If you need to use attribute values for composing other factory attributes on the fly Factory Girl has you covered. You just need to wrap the attribute value in a block and interpolate the attributes you need. These blocks have access to an <em>evaluator</em>—which is yielded to them—and which in turn has access to other attributes, even transient ones.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:supervillain</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span>       <span class="s1">&#39;Karl Stromberg&#39;</span>
</span><span class='line'>    <span class="n">passion</span>    <span class="s1">&#39;marine biology&#39;</span>
</span><span class='line'>    <span class="n">ambition</span>   <span class="s1">&#39;human extinction&#39;</span>
</span><span class='line'>    <span class="n">motivation</span> <span class="s1">&#39;save the oceans&#39;</span>
</span><span class='line'>    <span class="n">profile</span>    <span class="p">{</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> has a passion for </span><span class="si">#{</span><span class="n">passion</span><span class="si">}</span><span class="s2"> and aims to </span><span class="si">#{</span><span class="n">motivation</span><span class="si">}</span><span class="s2"> through </span><span class="si">#{</span><span class="n">ambition</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">villain</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:supervillain</span><span class="p">)</span>
</span><span class='line'><span class="n">villain</span><span class="o">.</span><span class="n">profile</span>
</span><span class='line'><span class="c1"># =&gt; &quot;Karl Stromberg has a passion for marine biology and aims to save the oceans through human extinction.&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><h3>Transient Attributes</h3></li>
</ul>


<p>I think its fair to call them fake attributes. These virtual attributes also allow you to pass addtional options when you construct your factory intances—via a hash of course. The instance itself won’t be affected by them since these attributes won’t be set on your factory object. On the other hand, Factory Girl treats transient attributes just like real ones. If you use <strong>attributes_for</strong>, they won’t show up though. <strong>Dependent attributes</strong> and <strong>Callbacks</strong> are able to access these fake attributes inside your factory. Overall, they are another strategy to keep your factories DRY.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:supervillain</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">transient</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">megalomaniac</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">cat_owner</span> <span class="kp">false</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">name</span>       <span class="s1">&#39;Karl Stromberg&#39;</span>
</span><span class='line'>    <span class="n">passion</span>    <span class="s1">&#39;marine biology&#39;</span>
</span><span class='line'>    <span class="n">ambition</span>   <span class="s1">&#39;human extinction&#39;</span>
</span><span class='line'>    <span class="n">motivation</span> <span class="p">{</span> <span class="s2">&quot;Building an underwater civilization</span><span class="si">#{</span><span class="s2">&quot; and saving the world&quot;</span> <span class="k">if</span> <span class="n">megalomaniac</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">profile</span>    <span class="p">{</span> <span class="s2">&quot;Insane business tycoon</span><span class="si">#{</span><span class="s2">&quot; – friends with Blofeld&quot;</span> <span class="k">if</span> <span class="n">cat_owner</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">villain</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:supervillain</span><span class="p">)</span>
</span><span class='line'><span class="n">villain</span><span class="o">.</span><span class="n">profile</span>
</span><span class='line'><span class="c1"># =&gt; &quot;Insane business tycoon&quot;</span>
</span><span class='line'><span class="n">villain</span><span class="o">.</span><span class="n">motivation</span>
</span><span class='line'><span class="c1"># =&gt; &quot;Building an underwater civilization&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">cat_friendly_villain</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:supervillain</span><span class="p">,</span> <span class="ss">cat_owner</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'><span class="n">cat_friendly_villain</span><span class="o">.</span><span class="n">profile</span>
</span><span class='line'><span class="c1"># =&gt; &quot;Insane business tycoon – friends with Blofeld&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">narcissistic_villain</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:supervillain</span><span class="p">,</span> <span class="ss">megalomaniac</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'><span class="n">narcissistic_villain</span><span class="o">.</span><span class="n">motivation</span>
</span><span class='line'><span class="c1"># =&gt; &quot;Building an underwater civilization and saving the world&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The example above turns out to be a bit more DRY since there was no need to create separate factories for supervillains that want to save the world or are friends with Blofeld repectively. Transient attributes give you the flexibility to make all kinds of adjustments and avoid creating a host of ever so similar factories.</p>

<p>!!! Section about callbacks using transient attributes</p>

<ul>
<li><h3>Lazy attributes</h3></li>
</ul>


<p>“Normal” attributes in Factory Girl are evaluated when the factory is defined. You usually provide static values as parameters to methods with the same name of your attributes. If you want to delay the evaluation until the last possible moment—when the instance gets instantiated—you will need to feed attributes their values via a code block. Associations and dynamically created values from objects like <strong>DateTime</strong> objects will be your most frequent customers for that lazy treatment.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:exploding_device</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">transient</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">countdown_seconds</span> <span class="mi">10</span><span class="o">*</span><span class="mi">60</span>
</span><span class='line'>      <span class="n">time_of_explosion</span> <span class="p">{</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">countdown_seconds</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">time_of_explosion</span> <span class="p">{</span> <span class="s2">&quot;Exploding in </span><span class="si">#{</span><span class="n">countdown_seconds</span><span class="si">}</span><span class="s2"> seconds </span><span class="si">#{</span><span class="n">time_of_explosion</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;at %I:%M %p&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">ticking_device</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:exploding_device</span><span class="p">)</span>
</span><span class='line'><span class="n">ticking_device</span><span class="o">.</span><span class="n">time_of_explosion</span>
</span><span class='line'><span class="c1"># =&gt; &quot;Exploding in 600 seconds at 11:53 PM&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><h3>Modifying Factories</h3></li>
</ul>


<p>Probably not a use case you’ll run into everyday but sometimes you inherit factories from other developers and you want to change them—in case you are using a TDD’d gem for example. If you feel the need to tweak these legacy factories to better fit your specific test scenarios you can modify them without creating new ones or using inheritance.</p>

<p>You do this via <strong>FactoryGirl.modify</strong> and it needs to be outside of that particular <strong>FactoryGirl.define</strong> block that you want to change. What you can’t do is modify <strong>sequence</strong> or <strong>trait</strong>—you can override attributes defined in via <strong>trait</strong> though. Callbacks on the “original” factory also won’t be overridden. The callback in your <strong>Factory.modify</strong> block will just be run as next in line.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:spy</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span>              <span class="s1">&#39;Marty McSpy&#39;</span>
</span><span class='line'>    <span class="n">skills</span>            <span class="s1">&#39;Espionage and infiltration&#39;</span>
</span><span class='line'>    <span class="n">deployment_status</span> <span class="s1">&#39;Preparing mission&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">modify</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">sequence</span> <span class="ss">:mission_deployment</span> <span class="k">do</span> <span class="o">|</span><span class="n">number</span><span class="o">|</span>
</span><span class='line'>    <span class="s2">&quot;Mission </span><span class="si">#{</span><span class="n">number</span><span class="si">}</span><span class="s2"> at </span><span class="si">#{</span><span class="no">DateTime</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_formatted_s</span><span class="p">(</span><span class="ss">:short</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:spy</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span>            <span class="s1">&#39;James Bond&#39;</span>
</span><span class='line'>    <span class="n">skills</span>          <span class="s1">&#39;CQC and poker&#39;</span>
</span><span class='line'>    <span class="n">favorite_weapon</span> <span class="s1">&#39;Walther PPK&#39;</span>
</span><span class='line'>    <span class="n">body_count</span>      <span class="s1">&#39;Classified&#39;</span>
</span><span class='line'>    <span class="n">favorite_car</span>    <span class="s1">&#39;Aston Martin DB9&#39;</span>
</span><span class='line'>    <span class="n">deployment</span>      <span class="p">{</span> <span class="n">generate</span><span class="p">(</span><span class="ss">:mission_deployment</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the example above we needed our spies to be a bit more “sophisticated” and use a better mechanism to handle deployment. I have seen examples where gem authors had to deal with time differently and where it was handy to modify factory objects by simply overriding stuff you need to tweak.</p>

<ul>
<li><h3>Callbacks</h3></li>
</ul>


<p>Callbacks allow you to inject some code at various moments in the life cycle of an object—like <strong>save</strong>, <strong>after_save</strong>, <strong>before_validation</strong> and so on. Rails for example offers a whole bunch of them and makes it pretty easy for novices to abuse this power. Keep in mind that callbacks that are not related to the persistance of objects are a known anti-pattern and its good advice to not cross that line. For example, it may seem convenient to use a callback after instantiating something like user to send emails or process some order but these kinds of things invite bugs and create ties that are unnecessarily harder to refactor. Maybe that was one of the reasons why Factory Girl “only” offers you five callback options to play with:</p>

<ul>
<li><p><strong>before(:create)</strong> executes a code block before your factory instance is saved. Activated when you use <strong>create(:some_object)</strong>.</p></li>
<li><p><strong>after(:create)</strong> executes a code block after your factory instance is saved. Activated when you use <strong>create(:some_object)</strong>.</p></li>
<li><p><strong>after(:build)</strong> executes a code block after your factory object has been built in memory. Activated when you use both <strong>build(:some_object)</strong> and <strong>create(:some_object)</strong>.</p></li>
<li><p><strong>after(:stub)</strong> executes a code block after your factory has created a stubbed object. Activated when you use <strong>build_stubbed(:some_object)</strong>.</p></li>
<li><p><strong>custom(:your_custom_callback)</strong> executes a custom callback without the need to prepend <strong>before</strong> or <strong>after</strong>.</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:mission</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">objective</span>        <span class="s1">&#39;Stopping the bad dude&#39;</span>
</span><span class='line'>    <span class="n">provided_gadgets</span> <span class="s1">&#39;Mini submarine and shark gun&#39;</span>
</span><span class='line'>    <span class="n">after</span><span class="p">(</span><span class="ss">:build</span><span class="p">)</span>    <span class="p">{</span> <span class="n">assign_support_analyst</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Attention!</h4>

<p>Note that for all callback options, inside the callback blocks, you’ll have access to an instance of the factory via a block parameter. This will come in handy every once in a while, especially with assocations.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:double_agent</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">after</span><span class="p">(</span><span class="ss">:stub</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">double_agent</span><span class="o">|</span> <span class="n">assign_new_identity</span><span class="p">(</span><span class="n">double_agent</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here a <strong>Ninja</strong> has a bunch of nasty throwing stars (shuriken) at his disposal. Since you have a ninja object in the callback you can easily assign the throwing star to belong to the Ninja. Take a peek at the section about <em>associations</em> if that example leaves you with a couple of question marks.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:ninja</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s2">&quot;Ra’s al Ghul&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">factory</span> <span class="ss">:ninja_with_shuriken</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">transient</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">number_of_shuriken</span> <span class="mi">10</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">after</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ninja</span><span class="p">,</span> <span class="n">evaluator</span><span class="o">|</span>
</span><span class='line'>        <span class="n">create_list</span><span class="p">(</span><span class="ss">:shuriken</span><span class="p">,</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">number_of_shuriken</span><span class="p">,</span> <span class="ss">ninja</span><span class="p">:</span> <span class="n">ninja</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:shuriken</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s1">&#39;Hira-shuriken&#39;</span>
</span><span class='line'>    <span class="n">number_of_spikes</span> <span class="s1">&#39;Four&#39;</span>
</span><span class='line'>    <span class="n">ninja</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">ninja</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:ninja</span><span class="p">)</span>
</span><span class='line'><span class="n">ninja</span><span class="o">.</span><span class="n">shuriken</span> <span class="c1"># =&gt; 0</span>
</span><span class='line'>
</span><span class='line'><span class="n">ninja</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:ninja_with_shuriken</span><span class="p">)</span>
</span><span class='line'><span class="n">ninja</span><span class="o">.</span><span class="n">shuriken</span> <span class="c1"># =&gt; 10</span>
</span><span class='line'>
</span><span class='line'><span class="n">ninja</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:ninja_with_shuriken</span><span class="p">,</span> <span class="ss">number_of_shuriken</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span>
</span><span class='line'><span class="n">ninja</span><span class="o">.</span><span class="n">shuriken</span> <span class="c1"># =&gt; 20</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also, through the evaluator object you have access to transient attributes too. That gives you the option to pass in addtional information when you “create” factory objects and need to tweak them on the fly. That gives you all the flexibility needed to play with associations and write expressive test data.</p>

<p>If you find the need to have multiple callbacks on your factory Factory Girl is not standing in your way—even multiple type ones. Naturally, order of execution is top to bottom.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:henchman</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s1">&#39;Mr. Hinx&#39;</span>
</span><span class='line'>    <span class="n">after</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">henchman</span><span class="o">|</span> <span class="n">send_on_kill_mission</span><span class="p">(</span><span class="n">henchman</span><span class="p">)</span>  <span class="p">}</span>
</span><span class='line'>    <span class="n">after</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span> <span class="p">{</span> <span class="n">send_cleaner</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:bond_girl</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s1">&#39;Lucia Sciarra&#39;</span>
</span><span class='line'>    <span class="n">after</span><span class="p">(</span><span class="ss">:build</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">bond_girl</span><span class="o">|</span> <span class="n">hide_secret_documents</span><span class="p">(</span><span class="n">bond_girl</span><span class="p">)</span>  <span class="p">}</span>
</span><span class='line'>    <span class="n">after</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span> <span class="p">{</span> <span class="n">close_hidden_safe_compartment</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The devil is in the details of course. If you use <strong>create(:some_object)</strong>, both <strong>after(:build)</strong> and <strong>after(:create)</strong> callbacks will be exectuted.</p>

<p>Multiple build strategies can be bundled to execute the same callback as well.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:spy</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s1">&#39;Marty McFly&#39;</span>
</span><span class='line'>    <span class="n">after</span><span class="p">(</span><span class="ss">:stub</span><span class="p">,</span> <span class="ss">:build</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">spy</span><span class="o">|</span> <span class="n">assign_new_mission</span><span class="p">(</span><span class="n">spy</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Last but not least, you can even setup something like “global” callbacks that override callbacks for all factories—at least in that particular file if you have separated them into multiple factory files.</p>

<p><strong>factories/gun.rb</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">before</span><span class="p">(</span><span class="ss">:stub</span><span class="p">,</span> <span class="ss">:build</span><span class="p">,</span> <span class="ss">:create</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">object</span><span class="o">|</span> <span class="n">assign_serial_number</span><span class="p">(</span><span class="n">object</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:spy_gun</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">model_name</span> <span class="s1">&#39;Walther PPK&#39;</span>
</span><span class='line'>    <span class="n">ammunition</span> <span class="s1">&#39;7.65mm Browning&#39;</span>
</span><span class='line'>    <span class="n">owner</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">factory</span> <span class="ss">:golden_gun</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">model_name</span> <span class="s1">&#39;Custom Lazar&#39;</span>
</span><span class='line'>      <span class="n">ammunition</span> <span class="s1">&#39;23-carat gold bullet&#39;</span>
</span><span class='line'>      <span class="n">after</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">golden_gun</span><span class="o">|</span> <span class="n">erase_serial_number</span><span class="p">(</span><span class="n">golden_gun</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Attention!</h4>

<p>If you use inheritance to compose child factories the callbacks on the parent will be inherited as well.</p>

<h3>The Last Mile</h3>

<p>Let’s bring it all together in the following sections about <em>associations</em> and <em>traits</em>—yes I also sneaked in <strong>alias</strong> because it was the best place without jumping all over the place. If you have paid attention and remember stuff from the first article everything should fall quite neatly into place now .</p>

<ul>
<li><h3>Associations</h3></li>
</ul>


<p>Associations are essential to every self respecting web app that has a little bit of complexity. A post that belongs to a user, a listing that has many ratings and so forth are the bread and butter developers have for breakfast any day of the week. Seen from that perspective it, becomes obvious that for more complex scenarios factories need to be bullet proof and easy to handle—at least in order to not mess with your TDD mojo. Emulating model associations via FactoryGirl is relatively straightforward I’d say. That in itself is quite amazing in my mind. Achieving a high level of ease and convenience for building complex data sets makes the practice of TDD a no-brainer and so much more effective.</p>

<p>The new Q has hacker skills and needs to own a decent computer right? In this case you have a <strong>Computer</strong> class and its instances belong to instances of the <strong>Quartermaster</strong> class. Easy right?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:quartermaster</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s1">&#39;Q&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:computer</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">model</span> <span class="s1">&#39;Custom Lenovo ThinkPad W Series&#39;</span>
</span><span class='line'>    <span class="n">quartermaster</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>What about something a bit more involved? Let’s say our spies use a <strong>gun</strong> that has_many <strong>cartridge(s)</strong> (bullets).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Cartridge</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:gun</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Gun</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:cartridges</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:cartridge</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">caliber</span> <span class="s1">&#39;7.65&#39;</span>
</span><span class='line'>    <span class="n">gun</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:gun</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">model_name</span> <span class="s1">&#39;Walther PPK&#39;</span>
</span><span class='line'>    <span class="n">ammunition</span> <span class="s1">&#39;7.65mm Browning&#39;</span>
</span><span class='line'>    <span class="n">caliber</span>    <span class="s1">&#39;7.65&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">factory</span> <span class="ss">:gun_with_ammo</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">transient</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">magazine_size</span> <span class="mi">10</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">after</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">gun</span><span class="p">,</span> <span class="n">evaluator</span><span class="o">|</span>
</span><span class='line'>        <span class="n">create_list</span><span class="p">(</span><span class="ss">:cartridge</span><span class="p">,</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">magazine_size</span><span class="p">,</span> <span class="ss">gun</span><span class="p">:</span> <span class="n">gun</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Callbacks come in pretty handy with associtations huh? Now you can build a gun with or without ammunition. Via the hash <strong>gun: gun</strong> you provided the <strong>cartridge</strong> factory with the necessary information to create the association via the <strong>foreign_key</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">spy_gun</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:gun</span><span class="p">)</span>
</span><span class='line'><span class="n">spy_gun</span><span class="o">.</span><span class="n">cartridges</span><span class="o">.</span><span class="n">length</span> <span class="c1"># =&gt; 0</span>
</span><span class='line'>
</span><span class='line'><span class="n">spy_gun_with_ammo</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:gun_with_ammo</span><span class="p">)</span>
</span><span class='line'><span class="n">spy_gun_with_ammo</span><span class="o">.</span><span class="n">cartridges</span><span class="o">.</span><span class="n">length</span> <span class="c1"># =&gt; 10</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you need another magazine size you can pass it in via your <strong>transient attribute</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">big_magazine_gun</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:gun_with_ammo</span><span class="p">,</span> <span class="ss">magazine_size</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span>
</span><span class='line'><span class="n">big_magazine_gun</span><span class="o">.</span><span class="n">cartridges</span><span class="o">.</span><span class="n">length</span> <span class="c1"># =&gt; 20</span>
</span></code></pre></td></tr></table></div></figure>


<p>So what about the different build strategies? Wasn’t there something fishy? Well, here’s what you need to remember: If you use <strong>create</strong> for associated objects both of them will be saved. So <strong>create(:quartermaster)</strong> will build and save both Q and his Thinkpad. I better use <strong>build</strong> then if I want to avoid hitting the database? Good idea but <strong>build</strong> would only apply to <strong>quartermaster</strong> in our example—the associated <strong>computer</strong> would still get saved. A bit tricky I know. Here’s what you can do if you need to avoid saving the associated object—you specify the build strategy you need for your association.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:quartermaster</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s1">&#39;Q&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:computer</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">model</span> <span class="s1">&#39;Custom Lenovo ThinkPad W Series&#39;</span>
</span><span class='line'>    <span class="n">association</span> <span class="ss">:quartermaster</span><span class="p">,</span> <span class="ss">strategy</span><span class="p">:</span> <span class="ss">:build</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>You name the associated factory object and pass in a hash with your build strategy. You need to use the explicit <strong>association</strong> call for this to work. The example below won’t work.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">factory</span> <span class="ss">:computer</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">model</span> <span class="s1">&#39;Custom Lenovo ThinkPad W Series&#39;</span>
</span><span class='line'>  <span class="n">quartermaster</span><span class="p">,</span> <span class="ss">strategy</span><span class="p">:</span> <span class="ss">:build</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now both objects use <strong>build</strong> and nothing gets saved to the database. We can check that assumption by using <strong>new_record?</strong> which returns <strong>true</strong> if the instance hasn’t been persisted.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">q</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="ss">:quartermaster</span><span class="p">)</span>
</span><span class='line'><span class="n">q</span><span class="o">.</span><span class="n">new_record?</span> <span class="c1"># =&gt; true</span>
</span><span class='line'><span class="n">q</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">new_record?</span> <span class="c1"># =&gt; true</span>
</span></code></pre></td></tr></table></div></figure>


<p>While we’re at it, via the explicit <strong>association</strong> call you can also refer to different factory names and change attributes on the fly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:quartermaster</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s1">&#39;Q&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:computer</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">model</span> <span class="s1">&#39;Custom Lenovo ThinkPad W Series&#39;</span>
</span><span class='line'>    <span class="n">association</span> <span class="ss">:hacker</span><span class="p">,</span> <span class="ss">factory</span><span class="p">:</span> <span class="ss">:quartermaster</span><span class="p">,</span> <span class="ss">skills</span><span class="p">:</span> <span class="s1">&#39;Hacking&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let’s close this chapter with an example that is <strong>polymorphic</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Spy</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:spyable</span><span class="p">,</span> <span class="ss">polymorpic</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">MIFive</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:spies</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:spyable</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">MISix</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:spies</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:spyable</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:mifive</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span>               <span class="s1">&#39;Military Intelligence, Section 5&#39;</span>
</span><span class='line'>    <span class="n">principal_activity</span> <span class="s1">&#39;Domestic counter-intelligence&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:misix</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span>               <span class="s1">&#39;Military Intelligence, Section 6&#39;</span>
</span><span class='line'>    <span class="n">principal_activity</span> <span class="s1">&#39;Foreign counter-intelligence&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:mifive_spy</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="no">Spy</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">association</span> <span class="ss">:spyable</span><span class="p">,</span> <span class="ss">factory</span><span class="p">:</span> <span class="ss">:mifive</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:misix_spy</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="no">Spy</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">association</span> <span class="ss">:spyable</span><span class="p">,</span> <span class="ss">factory</span><span class="p">:</span> <span class="ss">:misix</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Don’t feel bad if this one needs a bit more time to sink in. I recommend catching up on <a href="http://guides.rubyonrails.org/association_basics.html#polymorphic-associations"><strong>Polymorphic Associations</strong></a> if you’re unsure what’s going on here.</p>

<ul>
<li><h3>Aliases</h3></li>
</ul>


<p>Aliases for your factories allow you to be more expressive about the context that you are using your factory objects in. You only need to provide a hash of alternative names that better describe the relationship between associated objects.</p>

<p> Let’s say you have an <strong>:agent</strong> factory and a <strong>:law_enforcement_vehicle</strong> factory. Wouldn’t it be nice to refer to the agent as <strong>:owner</strong> in the context of these cars? In the example below I contrasted it with an example without an alias.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:agent</span><span class="p">,</span> <span class="ss">aliases</span><span class="p">:</span> <span class="o">[</span><span class="ss">:owner</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span>   <span class="s1">&#39;Fox Mulder&#39;</span>
</span><span class='line'>    <span class="n">job</span>    <span class="s1">&#39;Chasing bad dudes&#39;</span>
</span><span class='line'>    <span class="n">special_skills</span> <span class="s1">&#39;Investigation and intelligence&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">factory</span> <span class="ss">:double_O_seven</span> <span class="k">do</span>
</span><span class='line'>      <span class="nb">name</span> <span class="s1">&#39;James Bond&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:law_enforcement_vehicle</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s1">&#39;Oldsmobile Achieva&#39;</span>
</span><span class='line'>    <span class="n">kind</span> <span class="s1">&#39;Compact car&#39;</span>
</span><span class='line'>    <span class="n">owner</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:spy_car</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s1">&#39;Aston Martin DB9&#39;</span>
</span><span class='line'>    <span class="n">kind</span> <span class="s1">&#39;Sports car&#39;</span>
</span><span class='line'>    <span class="n">double_O_seven</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p> I think you’ll agree that using aliases it not only reads better but it also gives you or the person who comes after you a bit more context about the objects in question. Yeah, you need to use plural <strong>:aliases</strong> also if you have only a single alias.</p>

<p>You could write this a bit different as well—a lot more verbose.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">factory</span> <span class="ss">:agent</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">name</span>   <span class="s1">&#39;Fox Mulder&#39;</span>
</span><span class='line'>  <span class="n">job</span>    <span class="s1">&#39;Chasing bad dudes&#39;</span>
</span><span class='line'>  <span class="n">special_skills</span> <span class="s1">&#39;Investigation and intelligence&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">factory</span> <span class="ss">:law_enforcement_vehicle</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">name</span> <span class="s1">&#39;Oldsmobile Achieva&#39;</span>
</span><span class='line'>  <span class="n">kind</span> <span class="s1">&#39;Compact car&#39;</span>
</span><span class='line'>  <span class="n">association</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">factory</span><span class="p">:</span> <span class="ss">:agent</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, not that neat isn’t it?</p>

<p>In the context of comments, a <strong>:user</strong> could be referred to as <strong>:commenter</strong>, in the case of a <strong>:crime</strong> a <strong>:user</strong> could be aliased as a <strong>:suspect</strong> and so on. Its no rocket science really—more like convenient syntactic sugar that decreases your temptation for duplication.</p>

<ul>
<li><h3>Traits</h3></li>
</ul>


<p>This is one of my favorite things about Factory Girl. In a nutshell, traits are lego-like blocks to build your factories and mix in behaviour. In my mind, <strong>trait</strong> is the most powerful and convenient function to keep your factory data DRY and expressive. It allows you to bundle groups of attributes together, give them separate names and reuse them wherever you please. Remember when I urged you to define barebones factory objects? Traits will help you achieve exactly that without sacrificing any conveniences.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:spy_car</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">model</span>         <span class="s1">&#39;Aston Martin DB9&#39;</span>
</span><span class='line'>    <span class="n">top_speed</span>     <span class="s1">&#39;295 km/h&#39;</span>
</span><span class='line'>    <span class="n">build_date</span>    <span class="s1">&#39;2015&#39;</span>
</span><span class='line'>    <span class="n">ejection_seat</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:submarine</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">ejection_seat</span>              <span class="kp">false</span>
</span><span class='line'>      <span class="n">water_resistant</span>            <span class="s1">&#39;100 m&#39;</span>
</span><span class='line'>      <span class="n">submarine_capabilities</span>     <span class="kp">true</span>
</span><span class='line'>      <span class="n">air_independent_propulsion</span> <span class="kp">true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:weaponized</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">rockets</span>           <span class="kp">true</span>
</span><span class='line'>      <span class="n">number_of_rockets</span> <span class="s1">&#39;12&#39;</span>
</span><span class='line'>      <span class="n">machine_gun</span>       <span class="kp">true</span>
</span><span class='line'>      <span class="n">rate_of_fire</span>      <span class="s1">&#39;1,500 RPM&#39;</span>
</span><span class='line'>      <span class="n">tank_armour</span>       <span class="kp">true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:cloaked</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">active_camouflage</span> <span class="kp">true</span>
</span><span class='line'>      <span class="n">radar_signatur</span>    <span class="s1">&#39;reduced&#39;</span>
</span><span class='line'>      <span class="n">engine</span>            <span class="s1">&#39;silenced&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:night_vision</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">infrared_sensors</span> <span class="kp">true</span>
</span><span class='line'>      <span class="n">heads_up_display</span> <span class="kp">true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, if you want to change some attributes that are now spread over multiple objects, you can do that now in one central place. No shotgun surgery necessary. Managing state via traits couldn’t be more convenient. With that setup you can build pretty elaborate spy cars by mixing the various attribute bundles however you like—without duplicating anything via creating all sorts of new factories that account for all the various options you need.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">invisible_spy_car</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:spy_car</span><span class="p">,</span> <span class="ss">:cloaked</span><span class="p">,</span> <span class="ss">:night_vision</span><span class="p">)</span>
</span><span class='line'><span class="n">diving_spy_car</span>    <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:spy_car</span><span class="p">,</span> <span class="ss">:submarine</span><span class="p">,</span> <span class="ss">:cloaked</span><span class="p">)</span>
</span><span class='line'><span class="n">tank_spy_car</span>      <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:spy_car</span><span class="p">,</span> <span class="ss">:weaponized</span><span class="p">,</span> <span class="ss">:night_vision</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can use traits with <strong>create</strong>, <strong>build</strong>, <strong>build_stubbed</strong> and <strong>attributes_for</strong>. If Q gets clever, you can also ovverride individual attributes simultaneously by passing in a hash.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">build</span><span class="p">(</span><span class="ss">:spy_car</span><span class="p">,</span> <span class="ss">:submarine</span><span class="p">,</span> <span class="ss">ejection_seat</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>For trait combinations that occur very frequently on a particular factory you can also create child factories with names that best represent the various data set combos. That way you bundle their traits only once as opposed to all the time when you create test data.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGir</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:spy_car</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">model</span>         <span class="s1">&#39;Aston Martin DB9&#39;</span>
</span><span class='line'>    <span class="n">top_speed</span>     <span class="s1">&#39;295 km/h&#39;</span>
</span><span class='line'>    <span class="n">build_date</span>    <span class="s1">&#39;2015&#39;</span>
</span><span class='line'>    <span class="n">ejection_seat</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:submarine</span> <span class="k">do</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:weaponized</span> <span class="k">do</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:cloaked</span> <span class="k">do</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:night_vision</span> <span class="k">do</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">factory</span> <span class="ss">:invisible_spy_car</span><span class="p">,</span> <span class="ss">traits</span><span class="p">:</span> <span class="o">[</span><span class="ss">:cloaked</span><span class="p">,</span> <span class="ss">:night_vision</span><span class="o">]</span>
</span><span class='line'>    <span class="n">factory</span> <span class="ss">:diving_spy_car</span><span class="p">,</span>    <span class="ss">traits</span><span class="p">:</span> <span class="o">[</span><span class="ss">:submarine</span><span class="p">,</span> <span class="ss">:cloaked</span><span class="o">]</span>
</span><span class='line'>    <span class="n">factory</span> <span class="ss">:tank_spy_car</span><span class="p">,</span>      <span class="ss">traits</span><span class="p">:</span> <span class="o">[</span><span class="ss">:weaponized</span><span class="p">,</span> <span class="ss">:night_vision</span><span class="o">]</span>
</span><span class='line'>    <span class="n">factory</span> <span class="ss">:ultimate_spy_car</span><span class="p">,</span>  <span class="ss">traits</span><span class="p">:</span> <span class="o">[</span><span class="ss">:cloaked</span><span class="p">,</span> <span class="ss">:night_vision</span><span class="p">,</span> <span class="ss">:submarine</span><span class="p">,</span> <span class="ss">:weaponized</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This let’s you create these objects more much concise—more readable too.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">build_stubbed</span><span class="p">(</span><span class="ss">:invisible_spy_car</span><span class="p">)</span>
</span><span class='line'><span class="n">create</span><span class="p">(</span><span class="ss">:ultimate_spy_car</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instead of:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">build_stubbed</span><span class="p">(</span><span class="ss">:spy_car</span><span class="p">,</span> <span class="ss">:cloaked</span><span class="p">,</span> <span class="ss">:night_vision</span><span class="p">)</span>
</span><span class='line'><span class="n">create</span><span class="p">(</span><span class="ss">:spy_car</span><span class="p">,</span> <span class="ss">:cloaked</span><span class="p">,</span> <span class="ss">:night_vision</span><span class="p">,</span> <span class="ss">:submarine</span><span class="p">,</span> <span class="ss">:weaponized</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reads much better no? Especially when no variable names are involved.</p>

<p>You can even reuse traits as attributes on other traits and factories. If you define the same attributes for multiple traits, the last one defined gets precedence of course.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:spy_car</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">model</span>         <span class="s1">&#39;Aston Martin DB9&#39;</span>
</span><span class='line'>    <span class="n">top_speed</span>     <span class="s1">&#39;295 km/h&#39;</span>
</span><span class='line'>    <span class="n">build_date</span>    <span class="s1">&#39;2015&#39;</span>
</span><span class='line'>    <span class="n">ejection_seat</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:submarine</span> <span class="k">do</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:weaponized</span> <span class="k">do</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:cloaked</span> <span class="k">do</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:night_vision</span> <span class="k">do</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:mobile_surveillance</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">cloaked</span>
</span><span class='line'>      <span class="n">night_vision</span>
</span><span class='line'>      <span class="n">signal_detector</span>      <span class="kp">true</span>
</span><span class='line'>      <span class="n">signal_analyzer</span>      <span class="kp">true</span>
</span><span class='line'>      <span class="n">wifi_war_driver</span>      <span class="kp">true</span>
</span><span class='line'>      <span class="n">license_plate_reader</span> <span class="kp">true</span>
</span><span class='line'>      <span class="n">mini_drone</span>           <span class="kp">true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:ultimate_spy_car</span><span class="p">,</span> <span class="ss">parent</span><span class="p">:</span> <span class="ss">:spy_car</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">car_plane</span> <span class="kp">true</span>
</span><span class='line'>    <span class="n">submarine</span>
</span><span class='line'>    <span class="n">cloaked</span>
</span><span class='line'>    <span class="n">night_vision</span>
</span><span class='line'>    <span class="n">weaponized</span>
</span><span class='line'>    <span class="n">mobile_surveillance</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pay attention to the <strong>mobile_surveillance</strong> trait which reuses the <strong>cloaked</strong> and <strong>night_vision</strong> traits—basically as an attribute. Also the <strong>ultimate_spy_car</strong> factory, which I separated out of the <strong>spy_car</strong> factory definition for fun this time, reuses all traits plus an additional attribute that makes it fly too. Pure movie magic—or maybe I should say FactoryGirl magic.</p>

<p><strong>create_list</strong> and <strong>build_list</strong> can also make use of traits. The second parameter needs to be the number of factory instances you want.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">create_list</span><span class="p">(</span><span class="ss">:spy_car</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">:night_vision</span><span class="p">)</span>
</span><span class='line'><span class="n">build_list</span><span class="p">(</span><span class="ss">:spy_car</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="ss">:submarine</span><span class="p">,</span> <span class="ss">:cloaked</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wouldn’t it be cool to use associations with traits? Of course you can pack callbacks and associations neatly into traits. Duh!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:cartridge</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">kind</span>       <span class="s1">&#39;Small calliber pistol ammunition&#39;</span>
</span><span class='line'>    <span class="n">caliber</span>    <span class="s1">&#39;7.65&#39;</span>
</span><span class='line'>    <span class="n">projectile</span> <span class="s1">&#39;lead&#39;</span>
</span><span class='line'>    <span class="n">gun</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">factory</span> <span class="ss">:golden_cartridge</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">projectile</span> <span class="s1">&#39;gold&#39;</span>
</span><span class='line'>      <span class="ss">association</span><span class="p">:</span> <span class="ss">:gun</span><span class="p">,</span> <span class="ss">:golden</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:gun</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">model_name</span> <span class="s1">&#39;Walther PPK&#39;</span>
</span><span class='line'>    <span class="n">ammunition</span> <span class="s1">&#39;7.65mm Browning&#39;</span>
</span><span class='line'>    <span class="n">caliber</span>    <span class="s1">&#39;7.65&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:golden</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">model_name</span> <span class="s1">&#39;Custom Lazar&#39;</span>
</span><span class='line'>      <span class="n">ammunition</span> <span class="s1">&#39;23-carat gold bullet&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">trait</span> <span class="ss">:with_ammo</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">transient</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">magazine_size</span> <span class="mi">10</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">after</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">gun</span><span class="p">,</span> <span class="n">evaluator</span><span class="o">|</span>
</span><span class='line'>        <span class="n">create_list</span><span class="p">(</span><span class="ss">:cartridge</span><span class="p">,</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">magazine_size</span><span class="p">,</span> <span class="ss">gun</span><span class="p">:</span> <span class="n">gun</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>How to use them should be boring by now.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gun_with_ammo</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:gun</span><span class="p">,</span> <span class="ss">:with_ammo</span><span class="p">)</span>
</span><span class='line'><span class="n">gun_with_ammo</span><span class="o">.</span><span class="n">model_name</span> <span class="c1"># =&gt; &#39;Walther PPK&#39;</span>
</span><span class='line'><span class="n">gun_with_ammo</span><span class="o">.</span><span class="n">ammunition</span> <span class="c1"># =&gt; &#39;7.65mm Browning&#39; </span>
</span><span class='line'><span class="n">gun_with_ammo</span><span class="o">.</span><span class="n">cartridge</span><span class="o">.</span><span class="n">length</span> <span class="c1"># =&gt; 10</span>
</span><span class='line'><span class="n">gun_with_ammo</span><span class="o">.</span><span class="n">cartridge</span><span class="o">.</span><span class="n">projectice</span> <span class="c1"># =&gt; &#39;lead&#39;</span>
</span><span class='line'><span class="n">gun_with_ammo</span><span class="o">.</span><span class="n">cartridge</span><span class="o">.</span><span class="n">caliber</span> <span class="c1"># =&gt; &#39;7.65&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">golden_gun_with_ammo</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:gun</span><span class="p">,</span> <span class="ss">:golden</span><span class="p">,</span> <span class="ss">:with_ammo</span><span class="p">)</span>
</span><span class='line'><span class="n">golden_gun_with_ammo</span><span class="o">.</span><span class="n">model_name</span> <span class="c1"># =&gt; &#39;Custom Lazar&#39;</span>
</span><span class='line'><span class="n">golden_gun_with_ammo</span><span class="o">.</span><span class="n">ammunition</span> <span class="c1"># =&gt; &#39;23-carat gold bullet&#39; </span>
</span><span class='line'><span class="n">golden_gun_with_ammo</span><span class="o">.</span><span class="n">golden_cartridge</span><span class="o">.</span><span class="n">length</span> <span class="c1"># =&gt; 10</span>
</span><span class='line'><span class="n">golden_gun_with_ammo</span><span class="o">.</span><span class="n">golden_cartridge</span><span class="o">.</span><span class="n">projectice</span> <span class="c1"># =&gt; &#39;gold&#39;</span>
</span><span class='line'><span class="n">golden_gun_with_ammo</span><span class="o">.</span><span class="n">golden_cartridge</span><span class="o">.</span><span class="n">caliber</span> <span class="c1"># =&gt; &#39;7.65&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Last words of wisdom: Change is your constant companion—needing to change attributes or data types happens all the time. Design decisions like these evolve. Traits will ease the pain with that and helps you manage your data sets. Imagine if you’d have used an options hash for instantiation and that requirement totally changed. How many potential places in your tests might break and will now need attention? Straight up, <strong>trait</strong> is a very effective tool for eliminating duplication in your test suite. But with all that convenience, don’t be lazy and forget your unit tests on the columns that are represented by your traits! That way you give them the same amount of care as the barebones attributes needed for valid objects.</p>

<ul>
<li><h3>Final Thoughts</h3></li>
</ul>


<p>There is a bit more to discover in FactoryGirl and I’m confident you are now more than well equipped to to put the pieces together when you need them. Have fun playing with this gem. I hope your TDD habits will benefit from it.</p>

<p><img src="/octopress_drafts_previewer/images/Factory-Girl-Guide/Factory_Guide_Association_cropped.png"></p>

<h5>/spec/factories.rb</h5>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:spy</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s2">&quot;Marty McSpy&quot;</span>
</span><span class='line'>    <span class="n">favorite_gadget</span> <span class="s2">&quot;Hoverboard&quot;</span>
</span><span class='line'>    <span class="n">skills</span> <span class="s2">&quot;Infiltration and espionage&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h5>/spec/spy_spec.rb</h5>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="no">Spy</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;returns alias of a spy&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">spy</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:spy</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">spy</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_instance_of</span><span class="p">(</span><span class="no">Spy</span><span class="p">)</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">spy</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">&#39;Marty McSpy&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">spy</span><span class="o">.</span><span class="n">function</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">&#39;Covert agent&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">spy</span><span class="o">.</span><span class="n">skills</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">&#39;Infiltration and espionage&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:spy</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s2">&quot;Marty McSpy&quot;</span>
</span><span class='line'>    <span class="n">function</span> <span class="s2">&quot;Covert agent&quot;</span>
</span><span class='line'>    <span class="n">skills</span> <span class="s2">&quot;Infiltration and espionage&quot;</span>
</span><span class='line'>    <span class="n">date_of_birth</span> <span class="no">Date</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1968</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:quartermaster</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="no">Spy</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s2">&quot;Q&quot;</span>
</span><span class='line'>    <span class="n">function</span> <span class="s2">&quot;Quartermaster&quot;</span>
</span><span class='line'>    <span class="n">skills</span> <span class="s2">&quot;Inventing gizmos and hacking&quot;</span>
</span><span class='line'>    <span class="n">date_of_birth</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">factory</span> <span class="p">:</span><span class="mo">00</span> <span class="n">agent</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="no">Spy</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">name</span> <span class="s2">&quot;James Bond&quot;</span>
</span><span class='line'>    <span class="n">function</span> <span class="s2">&quot;Covert agent&quot;</span>
</span><span class='line'>    <span class="n">skills</span> <span class="s2">&quot;Getting Bond Girls killed and covert infiltration&quot;</span>
</span><span class='line'>    <span class="n">date_of_birth</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notes:
Factory girl is a ruby gem</p>

<p>it was data stored in yaml</p>

<p>have post with cretain attributes
can have associations(references to other factories), callbacks(for you create data), traits(mix in behaviour)</p>

<p>references to related data</p>

<p>override on the fly</p>

<p>attribute order does not matter</p>

<p>uses a lot of metaprogramming with a lot of dynamic method definitions</p>

<p>you can refer to attributes on objects even if you haven’t defined them in your factory. that means you can define factories with the absolute bare minimum to make them valid objects and assign attributes needed for your tests on the fly.</p>

<p>Want to have it DRY</p>

<p>create is actually going to persist the data. the goal is declaring bare bones factories and either have child factories and assign different attribues that mutate the data in a certain manner or that you use traits where you can mutate multiple columns (attributes) and change a handful of columns at at time or you can add associations or different callbacks.</p>

<p>Being able to define traits as a concept. for example flag on a post. published boolean and then requirements change and you need timestamp. later it changes again because you need state machine with published, not published, draft and so one. Instead of building a factory girl object and putting that column when you create this record ends up being a painfpoint because everything needs to change now when you refer to published-> all through your tests. -> traits just referring to this concept which lets you apply and affect changes in only one central DRY place. Imagine if you’d have used an options hash for instantiation and that requirement totally changed how many potential places in your tests might break and need attention now. with traits your test dont necessarily care about how its stored in the database.</p>

<p>traits are comma separated list of symbol traits / attributes that you wanna addon to a particular factory. traits are also defined in your factories file(s). traits is a tool for eliminating duplication in your test suite.</p>

<p>And because you still do (hopefully) unit tests on the columns  for your models that are represented in traits you give them you still give them the same amount of care than the attributes that are needed to have valid objects.</p>

<p>The more date you put in your global test space the more pain you are gonna have maintainance wise. Don’t be lazy!</p>

<p>When unit-testing most methods, however, Factory Girl (and even persisting data to the database) is unnecessary.</p>

<p>Outro</p>

<p>That’s also one more reason why only defining only the absolute basic objects and their attributes goes a long way in avoiding the side effects of global coupling. -> Bare minimum factory definitions and segregating related objects into separate factories or factories witht traits is the key thing to remember whatever you do.</p>

<p>A lot of times you actually dont need factory girl to write some of your unit tests. Josh would be the first to attest to that. Bigger systems with lots of data and collaborators and stuff that that you dont need for your unit tests. If you write unit tests and your data doesnt need any associations, it doesnt need persistance, you dont care about callbacks, dont use factory girl or at least use build (stubbed??) which instantiates the record and assignes all the attriubutes, gives it an id and raises if you interact with the database at all.  which gives you fake data that looks like its been persisted - gives you a full-fledged object that looks like its been saved. A lot faster. nothing hits the database at all.</p>

<p>Global coupling. Data is global in your test suite? it can become painful. When you change some attribute and tests start to break. Idea is to declare factories and then segregate them -> Something is different is named differently. A user with admin flag becomes admin in separate factory or trait. Regular user vs admin user -> Different type of users. Splitting up the data types helps ease some of the pain of the fact that they are global. So like changes to admin are less likely to break global things.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Your Name</span></span>

      




<time class='entry-date' datetime='2015-10-20T05:29:10+02:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:29 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/octopress_drafts_previewer/blog/categories/bdd/'>bdd</a>, <a class='category' href='/octopress_drafts_previewer/blog/categories/factory-girl/'>factory girl</a>, <a class='category' href='/octopress_drafts_previewer/blog/categories/rails/'>rails</a>, <a class='category' href='/octopress_drafts_previewer/blog/categories/rspec/'>rspec</a>, <a class='category' href='/octopress_drafts_previewer/blog/categories/ruby/'>ruby</a>, <a class='category' href='/octopress_drafts_previewer/blog/categories/tdd/'>tdd</a>, <a class='category' href='/octopress_drafts_previewer/blog/categories/test-driven-design/'>test-driven-design</a>, <a class='category' href='/octopress_drafts_previewer/blog/categories/thoughtbot/'>thoughtbot</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://vis-kid.github.io/octopress_drafts_previewer/blog/2015/10/20/Factory-Girl-Guide-02/" data-via="" data-counturl="http://vis-kid.github.io/octopress_drafts_previewer/blog/2015/10/20/Factory-Girl-Guide-02/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/octopress_drafts_previewer/blog/2015/10/12/Factory-Girl-Guide-01/" title="Previous Post: Factory Girl 101">&laquo; Factory Girl 101</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/octopress_drafts_previewer/blog/2015/10/20/Factory-Girl-Guide-02/">Factory Girl 201</a>
      </li>
    
      <li class="post">
        <a href="/octopress_drafts_previewer/blog/2015/10/12/Factory-Girl-Guide-01/">Factory Girl 101</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
